---
layout: post
title: æ·±å…¥ç ”ç©¶blocksè¯­æ³•
keywords: è¯­æ³•
category: è¯­æ³•
tags: [è¯­æ³•]
---

æˆ‘ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥å®šä¹‰å’Œä½¿ç”¨block

    void (^block1)(void) = ^void (void){
        NSLog(@"hello");
    };
    block1();
    
æ˜¯ä¸æ˜¯å¾ˆç®€å•å•Šï¼ä¹ˆå¾—ä»€ä¹ˆéš¾åº¦å˜›ï¼

###blockçš„å­˜åœ¨æ ·å¼
*.h*

  typedef `returnType`(^`name`)(`arguments`);

    typedef void(^block2)(void);
    typedef void(^block3)(NSInteger index);
    
    -(void)doSomethingWithBlock:(block2)block;
    
    @property (nonatomic, strong) dispatch_block_t block4;

*.m*

    self.block4 = ^{
        NSLog(@"hello");
    };
    
    self.block4();
    
    [self doSomethingWithBlock:^{
        NSLog(@"hello");
    }];
    
    -(void)doSomethingWithBlock:(block2)block{
        block();
    }
    
###blockçš„ç”¨å¤„
é¦–å…ˆæˆ‘ä»¬å¯ä»¥å›æƒ³ä¸‹ASIç½‘ç»œè®¿é—®å¤„ç†å¼‚æ­¥å›è°ƒçš„æ–¹æ³•ï¼Œé¦–å…ˆå¾—è®¾ç½®å½“å‰ä½¿ç”¨ç±»çš„ä»£ç†ï¼Œç„¶åå†™ä¸¤ä¸ªå›è°ƒæ–¹æ³•

    -(void)requestFinished:(ASIHTTPRequest *)req{

    }

    -(void)requestFailed:(ASIHTTPRequest *)req{

    }
    
å¦‚æœå½“å‰ç±»å¤„ç†è¯·æ±‚å¤šçš„è¯ï¼Œé‚£ä¹ˆå¯èƒ½éœ€è¦è®¾ç½®ä¸åŒçš„å›è°ƒæ–¹æ³•ä»¥åŒºåˆ†

    [request setDidFinishSelector:@selector(topSecretFetchComplete:)];
	[request setDidFailSelector:@selector(topSecretFetchFailed:)];
	
å¥½çƒ¦å•Šï¼Œå¥½å¤šä¸ªæ–¹æ³•ğŸ‘€éƒ½çœ‹ä¸æ¸…äº†ã€‚æˆ‘ä»¬æ¥æ”¹ä¸€æ”¹å§ã€‚å»ºä¸€ä¸ªASIHTTPRequestçš„åˆ†ç±»
*ASIHTTPRequest+blockAddtion.h*

    #import "ASIHTTPRequest.h"
    typedef void (^requestSuccessHandler)(ASIHTTPRequest *request);
    typedef void (^requestFailedHandler)(ASIHTTPRequest *request);

    @interface ASIHTTPRequest (blockAddtion)<ASIHTTPRequestDelegate>

    -(void)startAsynchronousWithSuccess:(requestSuccessHandler)success failed:(requestFailedHandler)failed;

    @end
    
*ASIHTTPRequest+blockAddtion.m*

    #import "ASIHTTPRequest+blockAddtion.h"
	#import <objc/runtime.h>
		
	static NSString * const handlerRunTimeAccosiationKey1 = @"requestSuccessHandler";
	static NSString * const handlerRunTimeAccosiationKey2 = @"requestFailedHandler";
		
	@implementation ASIHTTPRequest (blockAddtion)
		
	-(void)startAsynchronousWithSuccess:(requestSuccessHandler)success failed:(requestFailedHandler)failed{
	    objc_setAssociatedObject(self, (__bridge const void *)(handlerRunTimeAccosiationKey1), success, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
		objc_setAssociatedObject(self, (__bridge const void *)(handlerRunTimeAccosiationKey2), failed, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
		    
		[self setDelegate:self];
    }
		
	-(void)dealloc{
	    objc_removeAssociatedObjects(handlerRunTimeAccosiationKey1);
	    objc_removeAssociatedObjects(handlerRunTimeAccosiationKey2);
	    [super dealloc];
	}
	
	-(void)requestFinished:(ASIHTTPRequest *)req{
	    requestSuccessHandler completionHandler = objc_getAssociatedObject(self, (__bridge const void *)(handlerRunTimeAccosiationKey1));
	    if(completionHandler){
	        completionHandler(req);
	    }
	}
	
	-(void)requestFailed:(ASIHTTPRequest *)req{
	    requestFailedHandler completionHandler = objc_getAssociatedObject(self, (__bridge const void *)(handlerRunTimeAccosiationKey2));
	    if(completionHandler){
	        completionHandler(req);
	    }
	}
	
	@end


é‚£ä¹ˆç°åœ¨æˆ‘ä»¬åœ¨æ•°æ®è¯·æ±‚çš„æ—¶å€™å°±å¯ä»¥è¿™æ ·å†™

    [request startAsynchronousWithSuccess:^(ASIHTTPRequest *request) {
        
    } failed:^(ASIHTTPRequest *request) {
        
    }];
    
è¯·æ±‚æˆåŠŸæˆ–è€…å¤±è´¥éƒ½åœ¨é‡Œé¢å†™å°±å¥½å•¦ï¼
